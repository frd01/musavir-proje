
@Html.Hidden("Id")
@Html.Hidden("kasa_id")
@Html.Hidden("cari_id")

<div class="row">
    <div class="col-md-12 k-card">

        <div class="d-flex flex-row">
            <div class="p-2 text-right mt-1" style="width:20%;">
                @Html.Label("Tarih")
            </div>
            <div class="p-2" style="width : 30%;">
                @(
                    Html.Kendo().DatePicker()
                    .Name("kasa_dt_tarih")
                    .Value(DateTime.Now)
                    .Format("dd.MM.yyyy")
                    .HtmlAttributes(new {  style="width : 100%;",@class = "form-control form-control-sm" })
                    )
            </div>
            <div class="p-2 text-right mt-1" style="width:20%;">

                @Html.Label("Fiş No")
            </div>
            <div class="p-2" style="width : 30%;">
                @Html.Kendo().TextBox().Name("kasa_tx_fis_no").HtmlAttributes(new { style = "width : 100%;", @class = "form-control form-control-sm" })
            </div>

        </div>

        <div class="d-flex flex-row">
            <div class="p-2 text-right mt-1" style="width:20%;">
                @Html.Label("Kasa Adı")
            </div>
            <div class="p-2" style="width : 80%;">
                @(
                        Html.Kendo().ComboBox()
                        .Name("kasa_cm_kasalar")
                        .DataTextField("Tanim")
                        .DataValueField("Id")
                        .Suggest(true)
                        .Filter("contains")
                        .SelectedIndex(0)
                        .HtmlAttributes(new { style = "width : 100%;", @class = "form-control form-control-sm" })
                        .DataSource(datasource =>
                        {

                            datasource.Read("KasaKartFilterList", "kasa");
                        })
                        .Events(e=>e.Select("kasa_cm_kasalar_select_event"))
                        )
            </div>

        </div>

        <div class="d-flex flex-row">
            <div class="p-2 text-right mt-1" style="width:20%;">
                @Html.Label("Cari Adı")
            </div>
            <div class="p-2" style="width : 80%;">
                @(
                    Html.Kendo().ComboBox()
                    .Name("kasa_cm_cariler")
                    .Suggest(true)
                    .Filter("contains")
                    .DataTextField("Tanim")
                    .DataValueField("Id")
                    .HtmlAttributes(new { style = "width : 100%;", @class = "form-control form-control-sm" })
                    .DataSource(datasource =>
                    {

                        datasource.Read("CariFilterList", "kasa");
                    })
                    .Events(e=>e.Select("kasa_cm_cariler_select_event"))
                    )
            </div>
        </div>

        <div class="d-flex flex-row">
            <div class="p-2 text-right mt-1" style="width : 20%;">
                @Html.Label("Tutar")
            </div>
            <div class="p-2" style="width : 40%;">
                @(
                Html.Kendo().NumericTextBox()
                .Spinners(false)
                .Format("{0:n2}")
                .Name("kasa_tx_tutar")
                .HtmlAttributes(new { style = "width : 100%;", @class = "form-control form-control-sm" })
                )
            </div>
        </div>

        <div class="d-flex flex-row">
            <div class="p-2 text-right mt-1" style="width : 20%;">
                @Html.Label("Açıklama")
            </div>
            <div class="p-2" style="width : 70%;">
                @(
                Html.Kendo().TextArea().Name("kasa_tx_aciklama")
                .Rows(3)
                .HtmlAttributes(new { style = "width : 100%;" })
                )
            </div>
        </div>


    </div>
</div>

<hr />
<div class="row">
    <div class="col-md-12">

        <div class="d-flex flex-row justify-content-end">
            <div class="p-2">
                <button class="btn btn-warning" id="btn_cari_banka_fis_kayit" onclick="kasa_btn_tahsilat_click_event()">
                    <i class="fa-solid fa-floppy-disk"></i>
                    KAYDET
                </button>
            </div>
            <div class="p-2">
                <button class="btn btn-danger" id="kasa_btn_form_kapat()" onclick="btn_cari_banka_kapat_click_event()">
                    <i class="fa-solid fa-rectangle-xmark"></i>
                    KAPAT
                </button>
            </div>
        </div>

    </div>
</div>



<script>

    const kasa_fis_model = {

        Id: null,
        KasaId: 1,
        CariId: null,
        Tarih: null,
        Tutar: 0,
        Aciklama: "",
        FisNo : ""
    }

    function kasa_fis_form_temizle() {

        $("#kasa_tx_fis_no").data("kendoTextBox").value("")
        $("#kasa_cm_kasalar").data("kendoComboBox").value("")
        $("#kasa_cm_cariler").data("kendoComboBox").value("")
        $("#kasa_tx_tutar").data("kendoNumericTextBox").value("")
        $("#kasa_tx_aciklama").data("kendoTextArea").value("")
    }

    function kasa_cm_kasalar_select_event(e) {

        const dataItem = this.dataItem(e.item.index())

        kasa_fis_model.KasaId = dataItem.Id


    }

    function kasa_cm_cariler_select_event(e) {

        const dataItem = this.dataItem(e.item.index())

        kasa_fis_model.CariId = dataItem.Id

    }

    async function yeni_kasa_islem_kaydi() {

        const kasa_nakit_response = await $.ajax({

            url: "@Url.Action("KasaNakitIslem","kasa")",
            method: "POST",
            dataType: "Json",
            data: { islemTur: kasa_islem_tur, clientData: kasa_fis_model }
        })

        if (kasa_nakit_response != null) {

            const wn_fis = $("#wn_fis").data("kendoWindow")
            wn_fis.close()
            if (kasa_nakit_response.IslemDurum == false) {

                mesaj(kasa_nakit_response.Mesaj,"error")
            }
            if (kasa_nakit_response.IslemDurum == true) {

                mesaj(kasa_nakit_response.Mesaj, "success")
                window.location.reload()
            }


        }
    }

    async function kasa_islem_guncelleme() {

        kasa_fis_model.KasaId = Number($("#kasa_id").val())
        kasa_fis_model.CariId = Number($("#cari_id").val())
        kasa_fis_model.Id = Number($("#Id").val())
        
       
        const result = await $.ajax({

            url: "@Url.Action("KasaIslemGuncelleme", "kasa")",
            method: "POST",
            dataType: "Json",
            data: { clientData: kasa_fis_model, islemTur : kasa_islem_tur  }
        })

        if (result.IslemDurum == false) {

            alert(result.Mesaj)

        }

        if (result.IslemDurum == true) {

            const kasa_form = $("#wn_fis").data("kendoWindow")
            kasa_form.close()
            window.location.reload()
        }
    }

    async function kasa_btn_tahsilat_click_event() {

        const kasa_dt_tarih = $("#kasa_dt_tarih").data("kendoDatePicker").value()
        const kasa_tx_tutar = $("#kasa_tx_tutar").data("kendoNumericTextBox").value()
        const kasa_tx_aciklama = $("#kasa_tx_aciklama").data("kendoTextArea").value()
        const kasa_tx_fis_no = $("#kasa_tx_fis_no").data("kendoTextBox").value()


        if (kasa_dt_tarih != null) kasa_fis_model.Tarih = tarih_func(kasa_dt_tarih)

        if (kasa_tx_tutar != null) kasa_fis_model.Tutar = kasa_tx_tutar

        if (kasa_tx_aciklama != null) kasa_fis_model.Aciklama = kasa_tx_aciklama

        if (kasa_tx_fis_no != null) kasa_fis_model.FisNo = kasa_tx_fis_no

        const id = $("#Id").val()

        if (id.length <= 0) {

            await yeni_kasa_islem_kaydi()
        }
        else {

            await kasa_islem_guncelleme()
        }

    }

    function btn_cari_banka_kapat_click_event() {

        const wn_fis = $("#wn_fis").data("kendoWindow")

        wn_fis.close()
    }

    $(document).ready(function () {

        let kasa_tx_fis_no = $("#kasa_tx_fis_no").data("kendoTextBox")
        let kasa_cm_kasalar = $("#kasa_cm_kasalar").data("kendoComboBox")
        let kasa_cm_cariler = $("#kasa_cm_cariler").data("kendoComboBox")
        let kasa_tx_tutar = $("#kasa_tx_tutar").data("kendoNumericTextBox")
        let kasa_tx_aciklama = $("#kasa_tx_aciklama").data("kendoNumericTextArea")

        $("#kasa_dt_tarih").keyup(function (e) {

            if (e.keyCode == 13) kasa_tx_fis_no.focus()
        })

        $("#kasa_tx_fis_no").keyup(function (e) {

            if (e.keyCode == 13) kasa_cm_kasalar.focus()
        })

        $("#kasa_cm_kasalar").keyup(function (e) {

            if (e.keyCode == 13) kasa_cm_cariler.focus()
        })

        $("#kasa_cm_cariler").keyup(function (e) {

            if (e.keyCode == 13) kasa_tx_tutar.focus()
        })

        $("#kasa_tx_tutar").keyup(function (e) {

            if (e.keyCode == 13) kasa_tx_aciklama.focus()
        })
    })

</script>
